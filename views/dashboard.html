<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WAMulti</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i class="fab fa-whatsapp"></i></div>
                    <div class="logo-text">
                        <h2>WA<span>Multi</span></h2>
                        <p class="logo-tagline">Automation Platform</p>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-label">Main</div>
                <a href="#" class="nav-link active" data-view="dashboard">
                    <i class="fas fa-grid-2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-view="accounts">
                    <i class="fas fa-users"></i>
                    <span>Accounts</span>
                </a>
                <a href="#" class="nav-link" data-view="webhooks">
                    <i class="fas fa-link"></i>
                    <span>Webhooks</span>
                </a>
                <div class="nav-section-label">Settings</div>
                <a href="#" class="nav-link" data-view="system">
                    <i class="fas fa-server"></i>
                    <span>System</span>
                </a>
                <a href="#" class="nav-link" data-view="api-docs">
                    <i class="fas fa-code"></i>
                    <span>API Docs</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="system-status">
                    <div class="status-indicator online"></div>
                    <span>System Online</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="page-info">
                        <h1 class="page-title" id="pageTitle">Dashboard</h1>
                        <p class="page-subtitle" id="pageSubtitle">Overview of your WhatsApp automation</p>
                    </div>
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-primary" id="newAccountBtn">
                        <i class="fas fa-plus"></i>
                        <span>New Account</span>
                    </button>
                    <button class="btn btn-icon" id="logoutBtn" title="Logout">
                        <i class="fas fa-right-from-bracket"></i>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content" id="content">

                <!-- ============ Dashboard View ============ -->
                <div class="view active" id="dashboardView">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Total Accounts</span>
                                <span class="stat-value" id="totalAccounts">0</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green"><i class="fas fa-circle-check"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Active</span>
                                <span class="stat-value" id="activeAccounts">0</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon purple"><i class="fas fa-paper-plane"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Messages Sent</span>
                                <span class="stat-value" id="messagesSent">0</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange"><i class="fas fa-envelope"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Messages Received</span>
                                <span class="stat-value" id="messagesReceived">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title-group">
                                <h2>Connected Accounts</h2>
                                <span class="card-badge" id="accountCountBadge">0 accounts</span>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Account</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTable">
                                    <tr><td colspan="4" class="empty-state"><div class="empty-icon"><i class="fas fa-inbox"></i></div><p>Loading accounts...</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ============ Accounts View ============ -->
                <div class="view" id="accountsView">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title-group">
                                <h2>Manage Accounts</h2>
                            </div>
                            <div class="card-actions">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="accountSearchInput" placeholder="Search accounts..." oninput="filterAccounts(this.value)">
                                </div>
                                <button class="btn btn-primary" id="newAccountBtn2">
                                    <i class="fas fa-plus"></i> <span>Add Account</span>
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>API Key</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTableFull">
                                    <tr><td colspan="6" class="empty-state"><div class="empty-icon"><i class="fas fa-inbox"></i></div><p>Loading...</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ============ Webhooks View ============ -->
                <div class="view" id="webhooksView">
                    <!-- Webhook Stats -->
                    <div class="stats-grid stats-grid-sm">
                        <div class="stat-card compact">
                            <div class="stat-icon blue"><i class="fas fa-link"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Total Webhooks</span>
                                <span class="stat-value" id="webhookTotal">0</span>
                            </div>
                        </div>
                        <div class="stat-card compact">
                            <div class="stat-icon green"><i class="fas fa-circle-check"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Active</span>
                                <span class="stat-value" id="webhookActive">0</span>
                            </div>
                        </div>
                        <div class="stat-card compact">
                            <div class="stat-icon red"><i class="fas fa-triangle-exclamation"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Failed Deliveries</span>
                                <span class="stat-value" id="webhookFailed">0</span>
                            </div>
                        </div>
                        <div class="stat-card compact">
                            <div class="stat-icon purple"><i class="fas fa-chart-line"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Queue Size</span>
                                <span class="stat-value" id="webhookQueueSize">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title-group">
                                <h2>Webhook Configuration</h2>
                            </div>
                            <div class="card-actions">
                                <select id="webhookAccountSelect" class="select-modern">
                                    <option value="">Select Account</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="webhooksList">
                                <div class="empty-state-card">
                                    <i class="fas fa-link"></i>
                                    <p>Select an account to manage its webhooks</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Webhook Form -->
                    <div class="card" id="addWebhookCard" style="display:none; margin-top: 20px;">
                        <div class="card-header">
                            <h2>Add Webhook</h2>
                            <button class="btn btn-icon btn-sm" onclick="document.getElementById('addWebhookCard').style.display='none'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="addWebhookForm">
                                <input type="hidden" id="webhookFormAccountId">
                                <div class="form-group">
                                    <label>Webhook URL</label>
                                    <input type="url" id="webhookUrl" placeholder="https://your-n8n.com/webhook/..." required class="input-modern">
                                </div>
                                <div class="form-group">
                                    <label>Events</label>
                                    <div class="checkbox-grid">
                                        <label class="checkbox-card">
                                            <input type="checkbox" name="webhookEvents" value="message" checked>
                                            <span><i class="fas fa-envelope"></i> Messages</span>
                                        </label>
                                        <label class="checkbox-card">
                                            <input type="checkbox" name="webhookEvents" value="connection.update">
                                            <span><i class="fas fa-plug"></i> Connection</span>
                                        </label>
                                        <label class="checkbox-card">
                                            <input type="checkbox" name="webhookEvents" value="presence.update">
                                            <span><i class="fas fa-eye"></i> Presence</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Secret Key <span class="label-hint">(optional)</span></label>
                                    <div class="input-with-btn">
                                        <input type="text" id="webhookSecret" placeholder="Webhook secret for signature verification" class="input-modern">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="generateSecret()">Generate</button>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Save Webhook
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- ============ System View ============ -->
                <div class="view" id="systemView">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon green"><i class="fas fa-clock"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Uptime</span>
                                <span class="stat-value" id="sysUptime">-</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon blue"><i class="fas fa-microchip"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Memory Used</span>
                                <span class="stat-value" id="sysMemory">-</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon purple"><i class="fas fa-database"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Cache Hit Rate</span>
                                <span class="stat-value" id="sysCacheHit">-</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange"><i class="fas fa-bolt"></i></div>
                            <div class="stat-info">
                                <span class="stat-label">Node.js</span>
                                <span class="stat-value" id="sysNodeVersion" style="font-size: 18px;">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid-2col">
                        <!-- Active Connections -->
                        <div class="card">
                            <div class="card-header">
                                <h2>Active Connections</h2>
                                <button class="btn btn-secondary btn-sm" onclick="loadAccounts()">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body" id="activeConnectionsList">
                                <div class="empty-state-card compact">
                                    <i class="fas fa-plug"></i>
                                    <p>Loading connections...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Queue -->
                        <div class="card">
                            <div class="card-header">
                                <h2>Webhook Queue</h2>
                                <span class="card-badge green">In-Memory</span>
                            </div>
                            <div class="card-body" id="webhookQueueInfo">
                                <div class="queue-stats">
                                    <div class="queue-stat">
                                        <span class="queue-stat-label">Queue Size</span>
                                        <span class="queue-stat-value" id="queueSize">0 / 1000</span>
                                    </div>
                                    <div class="queue-stat">
                                        <span class="queue-stat-label">Processing</span>
                                        <span class="queue-stat-value" id="queueProcessing">Idle</span>
                                    </div>
                                    <div class="queue-stat">
                                        <span class="queue-stat-label">Delivered</span>
                                        <span class="queue-stat-value green" id="queueDelivered">0</span>
                                    </div>
                                    <div class="queue-stat">
                                        <span class="queue-stat-label">Failed</span>
                                        <span class="queue-stat-value red" id="queueFailedCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Server Configuration -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2>Server Configuration</h2>
                        </div>
                        <div class="card-body">
                            <div class="config-grid">
                                <div class="config-item">
                                    <span class="config-label">Platform</span>
                                    <span class="config-value" id="cfgPlatform">Node.js</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-label">Baileys Version</span>
                                    <span class="config-value">6.7.21</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-label">Session Storage</span>
                                    <span class="config-value">File System</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-label">Database</span>
                                    <span class="config-value">Supabase PostgreSQL</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-label">Max Accounts</span>
                                    <span class="config-value">Unlimited</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-label">AI Providers</span>
                                    <span class="config-value">OpenAI, Claude, Gemini, Groq, OpenRouter</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============ API Docs View ============ -->
                <div class="view" id="apiDocsView">
                    <div class="api-docs-layout">
                        <!-- Sidebar Navigation -->
                        <div class="api-sidebar">
                            <div class="api-sidebar-header">
                                <h3>Endpoints</h3>
                                <span class="version-tag">v4.0</span>
                            </div>
                            <nav class="api-nav">
                                <div class="api-nav-group">
                                    <button class="api-nav-group-toggle" onclick="toggleApiGroup(this)">
                                        <i class="fas fa-key"></i> Authentication
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </button>
                                    <div class="api-nav-items">
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('auth-login')">
                                            <span class="method-badge post">POST</span> /api/login
                                        </a>
                                    </div>
                                </div>
                                <div class="api-nav-group">
                                    <button class="api-nav-group-toggle" onclick="toggleApiGroup(this)">
                                        <i class="fas fa-users"></i> Accounts
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </button>
                                    <div class="api-nav-items">
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('get-accounts')">
                                            <span class="method-badge get">GET</span> /api/accounts
                                        </a>
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('create-account')">
                                            <span class="method-badge post">POST</span> /api/accounts
                                        </a>
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('delete-account')">
                                            <span class="method-badge delete">DEL</span> /api/accounts/:id
                                        </a>
                                    </div>
                                </div>
                                <div class="api-nav-group">
                                    <button class="api-nav-group-toggle active" onclick="toggleApiGroup(this)">
                                        <i class="fas fa-comment-dots"></i> Messages
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </button>
                                    <div class="api-nav-items show">
                                        <a href="#" class="api-nav-item active" onclick="showEndpoint('send-text')">
                                            <span class="method-badge post">POST</span> /api/send
                                        </a>
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('send-media')">
                                            <span class="method-badge post">POST</span> /api/send-media
                                        </a>
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('send-media-url')">
                                            <span class="method-badge post">POST</span> /api/send-media-url
                                        </a>
                                    </div>
                                </div>
                                <div class="api-nav-group">
                                    <button class="api-nav-group-toggle" onclick="toggleApiGroup(this)">
                                        <i class="fas fa-link"></i> Webhooks
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </button>
                                    <div class="api-nav-items">
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('get-webhooks')">
                                            <span class="method-badge get">GET</span> /api/webhooks/:accountId
                                        </a>
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('add-webhook')">
                                            <span class="method-badge post">POST</span> /api/webhooks
                                        </a>
                                    </div>
                                </div>
                                <div class="api-nav-group">
                                    <button class="api-nav-group-toggle" onclick="toggleApiGroup(this)">
                                        <i class="fas fa-server"></i> System
                                        <i class="fas fa-chevron-down toggle-icon"></i>
                                    </button>
                                    <div class="api-nav-items">
                                        <a href="#" class="api-nav-item" onclick="showEndpoint('health')">
                                            <span class="method-badge get">GET</span> /api/health
                                        </a>
                                    </div>
                                </div>
                            </nav>
                        </div>

                        <!-- API Content -->
                        <div class="api-content">
                            <div class="api-endpoint-detail" id="apiEndpointDetail">
                                <!-- Send Text Message (default) -->
                                <div class="endpoint-header">
                                    <span class="method-badge post large">POST</span>
                                    <code class="endpoint-url">/api/send</code>
                                </div>
                                <p class="endpoint-desc">Send a text message to a WhatsApp number or reply using fromJid from webhook.</p>

                                <div class="api-section">
                                    <h4>Headers</h4>
                                    <div class="code-block">
                                        <div class="code-header"><span>Headers</span></div>
                                        <pre><code>Content-Type: application/json</code></pre>
                                    </div>
                                </div>

                                <div class="api-section">
                                    <h4>Request Body</h4>
                                    <div class="code-block">
                                        <div class="code-header"><span>JSON</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>{
  "api_key": "YOUR_API_KEY",
  "to": "919876543210",
  "message": "Hello from WAMulti API!"
}</code></pre>
                                    </div>
                                </div>

                                <div class="api-section">
                                    <h4>Response</h4>
                                    <div class="code-block success">
                                        <div class="code-header"><span>200 OK</span></div>
                                        <pre><code>{
  "success": true,
  "messageId": "3EB0F4A2B3C4D5E6F7",
  "timestamp": 1706889600000
}</code></pre>
                                    </div>
                                </div>

                                <div class="api-section">
                                    <h4>cURL Example</h4>
                                    <div class="code-block">
                                        <div class="code-header"><span>Shell</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>curl -X POST https://YOUR_DOMAIN/api/send \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "to": "919876543210",
    "message": "Hello from WAMulti!"
  }'</code></pre>
                                    </div>
                                </div>

                                <div class="api-section">
                                    <h4>Reply Using Webhook Data</h4>
                                    <p class="section-desc">When you receive a webhook, use <code>fromJid</code> in the <code>to</code> field to reply:</p>
                                    <div class="code-block">
                                        <div class="code-header"><span>JSON - n8n HTTP Request</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>{
  "api_key": "YOUR_API_KEY",
  "to": "{{ $json.data.fromJid }}",
  "message": "Thanks {{ $json.data.pushName }}! You said: {{ $json.data.message }}"
}</code></pre>
                                    </div>
                                </div>

                                <!-- n8n Integration Guide -->
                                <div class="integration-card">
                                    <div class="integration-header">
                                        <div class="integration-icon">
                                            <i class="fas fa-diagram-project"></i>
                                        </div>
                                        <div>
                                            <h4>n8n Integration Guide</h4>
                                            <p>Step-by-step setup for n8n workflows</p>
                                        </div>
                                    </div>
                                    <div class="integration-steps">
                                        <div class="step">
                                            <span class="step-num">1</span>
                                            <div>
                                                <strong>Create Webhook Trigger</strong>
                                                <p>Add a Webhook node in n8n. Copy the Production URL and add it in the Webhooks section of this dashboard.</p>
                                            </div>
                                        </div>
                                        <div class="step">
                                            <span class="step-num">2</span>
                                            <div>
                                                <strong>Add HTTP Request Node</strong>
                                                <p>Method: POST, URL: https://YOUR_DOMAIN/api/send</p>
                                            </div>
                                        </div>
                                        <div class="step">
                                            <span class="step-num">3</span>
                                            <div>
                                                <strong>Set JSON Body</strong>
                                                <p>Use api_key, to: {{ $json.data.fromJid }}, message: your text</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Webhook Payload Reference -->
                                <div class="api-section">
                                    <h4>Incoming Webhook Payload</h4>
                                    <p class="section-desc">This is the payload your webhook URL will receive when a message comes in:</p>
                                    <div class="code-block">
                                        <div class="code-header"><span>Webhook Payload</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>{
  "event": "message",
  "timestamp": "2026-02-10T12:00:00.000Z",
  "account_id": "uuid-here",
  "data": {
    "messageId": "ABC123",
    "from": "918005780278",
    "fromJid": "918005780278@s.whatsapp.net",
    "isLidSender": false,
    "message": "Hello!",
    "messageType": "text",
    "isGroup": false,
    "pushName": "John Doe"
  }
}

// n8n field access:
// Reply To:     {{ $json.data.fromJid }}
// Message:      {{ $json.data.message }}
// Sender Name:  {{ $json.data.pushName }}</code></pre>
                                    </div>
                                </div>

                                <!-- Send Media -->
                                <div class="api-section">
                                    <h4>Send Media via URL</h4>
                                    <div class="endpoint-header compact">
                                        <span class="method-badge post">POST</span>
                                        <code class="endpoint-url">/api/send-media-url</code>
                                    </div>
                                    <div class="code-block">
                                        <div class="code-header"><span>JSON</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>{
  "api_key": "YOUR_API_KEY",
  "to": "{{ $json.data.fromJid }}",
  "mediaType": "image",
  "mediaUrl": "https://example.com/image.jpg",
  "caption": "Here's your image!"
}

// mediaType options: image, video, audio, document</code></pre>
                                    </div>
                                </div>

                                <!-- Send Base64 -->
                                <div class="api-section">
                                    <h4>Send Media via Base64</h4>
                                    <div class="code-block">
                                        <div class="code-header"><span>JSON - For n8n binary data</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>{
  "api_key": "YOUR_API_KEY",
  "to": "{{ $json.data.fromJid }}",
  "mediaType": "document",
  "mediaBase64": "{{ $binary.data.data }}",
  "mimetype": "{{ $binary.data.mimeType }}",
  "filename": "{{ $binary.data.fileName }}",
  "caption": "Your document"
}</code></pre>
                                    </div>
                                </div>

                                <!-- Webhook Signature -->
                                <div class="api-section">
                                    <h4>Webhook Signature Verification</h4>
                                    <p class="section-desc">If you set a webhook secret, verify signatures in n8n with a Code node:</p>
                                    <div class="code-block">
                                        <div class="code-header"><span>JavaScript - n8n Code Node</span><button class="copy-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button></div>
                                        <pre><code>const crypto = require('crypto');
const signature = $input.first().headers['x-webhook-signature-256'];
const payload = JSON.stringify($input.first().json);
const secret = 'YOUR_WEBHOOK_SECRET';

const expected = 'sha256=' + crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

if (signature !== expected) {
  throw new Error('Invalid signature');
}
return $input.all();</code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ============ Modals ============ -->

    <!-- QR Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-qrcode" style="color: var(--primary)"></i>
                    <h3>Scan QR Code</h3>
                </div>
                <button class="modal-close" id="closeQrModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="qrContainer" class="qr-container">
                    <div class="qr-placeholder">
                        <div class="qr-spinner"></div>
                        <p>Initializing connection...</p>
                    </div>
                </div>
                <div class="qr-instructions">
                    <div class="qr-step"><span>1</span> Open WhatsApp on your phone</div>
                    <div class="qr-step"><span>2</span> Go to Settings â†’ Linked Devices</div>
                    <div class="qr-step"><span>3</span> Tap "Link a Device" and scan</div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Account Modal -->
    <div class="modal" id="newAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-plus" style="color: var(--primary)"></i>
                    <h3>Create New Account</h3>
                </div>
                <button class="modal-close" id="closeNewAccountModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="newAccountForm">
                    <div class="form-group">
                        <label for="accountName">Account Name</label>
                        <input type="text" id="accountName" required placeholder="e.g. Business Main" class="input-modern">
                    </div>
                    <div class="form-group">
                        <label for="accountDesc">Description <span class="label-hint">(optional)</span></label>
                        <input type="text" id="accountDesc" placeholder="e.g. Main business account" class="input-modern">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-plus"></i> Create Account
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Config Modal -->
    <div class="modal" id="aiConfigModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-robot" style="color: var(--primary)"></i>
                    <h3>AI Chatbot Configuration</h3>
                </div>
                <button class="modal-close" id="closeAiConfigModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="chatbot-toggle-container">
                    <div class="toggle-info">
                        <i class="fas fa-robot"></i>
                        <span>AI Chatbot</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="aiActive" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-status" id="toggleStatus">Enabled</span>
                </div>

                <form id="aiConfigForm">
                    <input type="hidden" id="aiAccountId">
                    <div class="form-group">
                        <label for="aiProvider">AI Provider</label>
                        <select id="aiProvider" class="select-modern" required>
                            <option value="">Select Provider</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="groq">Groq (Fast & Free)</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aiApiKey">API Key</label>
                        <input type="password" id="aiApiKey" required placeholder="sk-..." class="input-modern">
                    </div>
                    <div class="form-group">
                        <label for="aiModel">Model</label>
                        <select id="aiModel" class="select-modern" required>
                            <option value="">Select Model (choose provider first)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aiSystemPrompt">System Prompt</label>
                        <textarea id="aiSystemPrompt" rows="4" placeholder="You are a helpful customer support assistant..." class="input-modern"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="aiTemperature">Temperature</label>
                            <input type="number" id="aiTemperature" min="0" max="2" step="0.1" value="0.7" class="input-modern">
                        </div>
                        <div class="form-group half">
                            <label for="aiMemoryLimit">Memory (messages)</label>
                            <input type="number" id="aiMemoryLimit" min="1" max="50" value="10" class="input-modern">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="aiMemoryEnabled" checked>
                            <span>Enable Conversation Memory</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="deleteAiConfig">
                            <i class="fas fa-trash"></i> Delete Config
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>
