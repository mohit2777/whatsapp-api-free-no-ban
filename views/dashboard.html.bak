<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WhatsApp Multi-Automation</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i class="fab fa-whatsapp"></i></div>
                    <h2>WA<span>Multi</span></h2>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" data-view="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-view="accounts">
                    <i class="fas fa-users"></i>
                    <span>Accounts</span>
                </a>
                <a href="#" class="nav-link" data-view="webhooks">
                    <i class="fas fa-link"></i>
                    <span>Webhooks</span>
                </a>
                <a href="#" class="nav-link" data-view="system">
                    <i class="fas fa-server"></i>
                    <span>System</span>
                </a>
                <a href="#" class="nav-link" data-view="api-docs">
                    <i class="fas fa-code"></i>
                    <span>API Docs</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="status-indicator online"></div>
                <span>System Online</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="topbar-actions">
                    <button class="btn btn-primary" id="newAccountBtn">
                        <i class="fas fa-plus"></i> New Account
                    </button>
                    <button class="btn btn-icon" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content" id="content">
                <!-- Dashboard View -->
                <div class="view active" id="dashboardView">
                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="totalAccounts">0</span>
                                <span class="stat-label">Total Accounts</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon online"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="activeAccounts">0</span>
                                <span class="stat-label">Active</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-paper-plane"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="messagesSent">0</span>
                                <span class="stat-label">Messages Sent</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="messagesReceived">0</span>
                                <span class="stat-label">Messages Received</span>
                            </div>
                        </div>
                    </div>

                    <!-- Accounts Table -->
                    <div class="card">
                        <div class="card-header">
                            <h2>Connected Accounts</h2>
                        </div>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Account</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTable">
                                    <tr>
                                        <td colspan="4" class="loading">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Accounts View -->
                <div class="view" id="accountsView">
                    <div class="card">
                        <div class="card-header">
                            <h2>Manage Accounts</h2>
                            <button class="btn btn-primary" id="newAccountBtn2">
                                <i class="fas fa-plus"></i> New Account
                            </button>
                        </div>
                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>Status</th>
                                        <th>API Key</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTableFull">
                                    <tr>
                                        <td colspan="6" class="loading">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Webhooks View -->
                <div class="view" id="webhooksView">
                    <div class="card">
                        <div class="card-header">
                            <h2>Webhook Configuration</h2>
                        </div>
                        <div class="card-body">
                            <p class="info-text">Select an account to manage its webhooks.</p>
                            <select id="webhookAccountSelect" class="select">
                                <option value="">Select Account</option>
                            </select>
                            <div id="webhooksList" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>

                <!-- System View -->
                <div class="view" id="systemView">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="sysUptime">-</span>
                                <span class="stat-label">Uptime</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-memory"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="sysMemory">-</span>
                                <span class="stat-label">Memory Used</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-database"></i></div>
                            <div class="stat-info">
                                <span class="stat-value" id="sysCacheHit">-</span>
                                <span class="stat-label">Cache Hit Rate</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Docs View -->
                <div class="view" id="apiDocsView">
                    <div class="card">
                        <div class="card-header">
                            <h2>API Documentation for n8n Integration</h2>
                        </div>
                        <div class="card-body api-docs">
                            <div class="api-section">
                                <h2>üöÄ Quick Start</h2>
                                <p class="info-text">Use your API key from the Accounts page. Replace YOUR_DOMAIN with your server URL.</p>
                                <p class="info-text" style="color: #2ecc71;"><strong>‚úÖ Simple:</strong> Use the <code>to</code> field for both phone numbers AND JIDs (LIDs). The API auto-detects the format!</p>
                            </div>

                            <h3>üì§ 1. Send Text Message</h3>
                            <p class="info-text">POST /api/send - Works with phone number OR JID (fromJid from webhook)</p>
                            <pre><code># Reply to a message using fromJid from webhook:
curl -X POST https://YOUR_DOMAIN/api/send \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "to": "{{ $json.data.fromJid }}",
    "message": "Thanks for your message!"
  }'

# Or send to a known phone number:
curl -X POST https://YOUR_DOMAIN/api/send \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "to": "918005780278",
    "message": "Hello!"
  }'</code></pre>

                            <h3>üì∑ 2. Send Media via File Upload</h3>
                            <p class="info-text">POST /api/send-media (multipart/form-data) - Use <code>to</code> for both phone and JID</p>
                            <pre><code># Send to phone number:
curl -X POST https://YOUR_DOMAIN/api/send-media \
  -F "api_key=YOUR_API_KEY" \
  -F "to=918005780278" \
  -F "mediaType=image" \
  -F "caption=Check this out!" \
  -F "media=@/path/to/image.jpg"

# Reply using fromJid from webhook:
curl -X POST https://YOUR_DOMAIN/api/send-media \
  -F "api_key=YOUR_API_KEY" \
  -F "to={{ $json.data.fromJid }}" \
  -F "mediaType=image" \
  -F "caption=Check this out!" \
  -F "media=@/path/to/image.jpg"

# mediaType options: image, video, audio, document</code></pre>

                            <h3>üîó 3. Send Media via URL (Best for n8n)</h3>
                            <p class="info-text">POST /api/send-media-url - Use <code>to</code> for both phone and JID</p>
                            <pre><code># Reply with image:
curl -X POST https://YOUR_DOMAIN/api/send-media-url \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "to": "{{ $json.data.fromJid }}",
    "mediaType": "image",
    "mediaUrl": "https://example.com/image.jpg",
    "caption": "Here is your image!"
  }'</code></pre>

                            <h3>üìù 4. Send Media via Base64</h3>
                            <p class="info-text">POST /api/send-media-url (JSON body with base64)</p>
                            <pre><code>curl -X POST https://YOUR_DOMAIN/api/send-media-url \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "to": "{{ $json.data.fromJid }}",
    "mediaType": "document",
    "mediaBase64": "{{ $binary.data.data }}",
    "mimetype": "application/pdf",
    "filename": "document.pdf",
    "caption": "Your document"
  }'</code></pre>

                            <h3>‚úÖ Success Response</h3>
                            <pre><code>{
  "success": true,
  "messageId": "ABCD1234567890",
  "timestamp": 1706889600000
}</code></pre>

                            <h3>‚ùå Error Response</h3>
                            <pre><code>{
  "success": false,
  "error": "Account not connected"
}</code></pre>

                            <hr style="margin: 30px 0; border-color: var(--border);">

                            <h2 style="color: var(--primary); margin-bottom: 20px;">üîó n8n HTTP Request Node Configurations</h2>
                            
                            <h3>üì• Step 1: Receive Messages (Webhook Trigger)</h3>
                            <p class="info-text">Create a Webhook node in n8n as trigger, then add the URL to your account's webhooks in this dashboard.</p>
                            <pre><code># n8n Webhook Node Setup:
Method: POST
Path: /whatsapp-messages
Copy the Production URL to this dashboard's Webhooks section

# Incoming Webhook Payload:
{
  "event": "message",
  "timestamp": "2026-02-03T12:00:00.000Z",
  "account_id": "uuid-here",
  "data": {
    "messageId": "ABC123",
    "from": "918005780278",        ‚Üê May be LID if sender not in contacts
    "fromJid": "918005780278@s.whatsapp.net",  ‚Üê USE THIS FOR REPLIES!
    "isLidSender": false,         ‚Üê true if 'from' is LID (not real phone)
    "message": "Hello!",           ‚Üê MESSAGE TEXT
    "messageType": "text",
    "isGroup": false,
    "pushName": "John Doe"         ‚Üê SENDER'S NAME
  }
}

# Access in n8n:
Reply To:     {{ $json.data.fromJid }}  ‚Üê USE THIS IN 'to' FIELD
Message Text: {{ $json.data.message }}
Sender Name:  {{ $json.data.pushName }}</code></pre>

                            <h3>üì§ Step 2: Send Text Reply (HTTP Request Node)</h3>
                            <p class="info-text">Use <code>fromJid</code> from webhook in the <code>to</code> field</p>
                            <pre><code># n8n HTTP Request Node Configuration:

Method: POST
URL: https://YOUR_DOMAIN/api/send
Authentication: None
Body Content Type: JSON

JSON Body (copy this exactly):
{
  "api_key": "YOUR_API_KEY",
  "to": "{{ $json.data.fromJid }}",
  "message": "Thanks {{ $json.data.pushName }}! You said: {{ $json.data.message }}"
}

# Or send to a specific phone number (for campaigns):
{
  "api_key": "YOUR_API_KEY",
  "to": "918005780278",
  "message": "Hello!"
}</code></pre>

                            <h3>üñºÔ∏è Step 3: Send Image from URL (HTTP Request Node)</h3>
                            <pre><code># n8n HTTP Request Node Configuration:

Method: POST
URL: https://YOUR_DOMAIN/api/send-media-url
Authentication: None
Body Content Type: JSON

JSON Body:
{
  "api_key": "YOUR_API_KEY",
  "to": "{{ $json.data.fromJid }}",
  "mediaType": "image",
  "mediaUrl": "https://example.com/image.jpg",
  "caption": "Here's your image!"
}</code></pre>

                            <h3>üìé Step 4: Send Document from Binary Data (HTTP Request Node)</h3>
                            <pre><code># n8n HTTP Request Node Configuration:

Method: POST
URL: https://YOUR_DOMAIN/api/send-media-url
Authentication: None
Body Content Type: JSON

JSON Body:
{
  "api_key": "YOUR_API_KEY",
  "to": "{{ $json.data.fromJid }}",
  "mediaType": "document",
  "mediaBase64": "{{ $binary.data.data }}",
  "mimetype": "{{ $binary.data.mimeType }}",
  "filename": "{{ $binary.data.fileName }}",
  "caption": "Your document"
}</code></pre>

                            <hr style="margin: 30px 0; border-color: var(--border);">

                            <h2 style="color: var(--primary); margin-bottom: 20px;">üìã Complete n8n Workflow Example</h2>
                            <pre><code># Auto-Reply Workflow Structure:

[Webhook Trigger] ‚Üí [IF Node] ‚Üí [HTTP Request]
                         ‚Üì
                   [Set Node for complex replies]

# Step-by-step:

1. Webhook Node (Trigger)
   - Method: POST
   - Path: /whatsapp-incoming
   - Copy Production URL to dashboard webhooks

2. IF Node (Optional - Filter messages)
   - Condition: {{ $json.event }} = "message"
   - AND: {{ $json.data.isGroup }} = false

3. HTTP Request Node (Send Reply)
   - Method: POST
   - URL: https://YOUR_DOMAIN/api/send
   - Body: JSON
   - Content:
     {
       "api_key": "YOUR_API_KEY",
       "to": "{{ $json.data.fromJid }}",
       "message": "Thanks {{ $json.data.pushName }}!"
     }
     
# The "to" field accepts BOTH:
# - fromJid from webhook (for replies) 
# - Phone numbers (for campaigns)</code></pre>

                            <h3>üîê Webhook Signature Verification (Optional)</h3>
                            <pre><code># If you set a webhook secret, n8n Code node:

const crypto = require('crypto');
const signature = $input.first().headers['x-webhook-signature-256'];
const payload = JSON.stringify($input.first().json);
const secret = 'YOUR_WEBHOOK_SECRET';

const expected = 'sha256=' + crypto
  .createHmac('sha256', secret)
  .update(payload)
  .digest('hex');

if (signature !== expected) {
  throw new Error('Invalid signature');
}

return $input.all();</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Scan QR Code</h3>
                <button class="modal-close" id="closeQrModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="qrContainer">
                    <p>Waiting for QR code...</p>
                </div>
                <p class="qr-instructions">Open WhatsApp on your phone, go to Settings > Linked Devices > Link a Device</p>
            </div>
        </div>
    </div>

    <div class="modal" id="newAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Account</h3>
                <button class="modal-close" id="closeNewAccountModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="newAccountForm">
                    <div class="form-group">
                        <label for="accountName">Account Name</label>
                        <input type="text" id="accountName" required placeholder="My WhatsApp">
                    </div>
                    <div class="form-group">
                        <label for="accountDesc">Description (optional)</label>
                        <input type="text" id="accountDesc" placeholder="Business account">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="aiConfigModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>AI Chatbot Configuration</h3>
                <button class="modal-close" id="closeAiConfigModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Chatbot Toggle at Top -->
                <div class="chatbot-toggle-container">
                    <div class="toggle-info">
                        <i class="fas fa-robot"></i>
                        <span>AI Chatbot</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="aiActive" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-status" id="toggleStatus">Enabled</span>
                </div>

                <form id="aiConfigForm">
                    <input type="hidden" id="aiAccountId">
                    <div class="form-group">
                        <label for="aiProvider">AI Provider</label>
                        <select id="aiProvider" class="select" required>
                            <option value="">Select Provider</option>
                            <option value="openai">OpenAI (GPT)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="groq">Groq (Fast & Free)</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aiApiKey">API Key</label>
                        <input type="password" id="aiApiKey" required placeholder="sk-...">
                    </div>
                    <div class="form-group">
                        <label for="aiModel">Model</label>
                        <select id="aiModel" class="select" required>
                            <option value="">Select Model (choose provider first)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="aiSystemPrompt">System Prompt</label>
                        <textarea id="aiSystemPrompt" rows="4" placeholder="You are a helpful customer support assistant. Be friendly and concise."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="aiTemperature">Temperature</label>
                            <input type="number" id="aiTemperature" min="0" max="2" step="0.1" value="0.7">
                        </div>
                        <div class="form-group half">
                            <label for="aiMemoryLimit">Memory (messages)</label>
                            <input type="number" id="aiMemoryLimit" min="1" max="50" value="10" title="How many previous messages to remember">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="aiMemoryEnabled" checked>
                            <span>Enable Conversation Memory (remember previous messages)</span>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-danger" id="deleteAiConfig">Delete Config</button>
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>
